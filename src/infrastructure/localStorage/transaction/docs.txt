#
Реализация транзакции

#
Реализация транзакций, если она возможна.

#
В транзакции нельзя принимать решения на основании данных, прочитанных предыдущим оператором, ведь за время между выполнением операторов все может измениться.
Как написать код корректно:
- Заменить процедурный код декларативным.
Например, проверка легко превращается в ограничение целостности:
ALTER TABLE accounts ADD CHECK amount >= 0;
Теперь никакие проверки в коде не нужны: достаточно просто выполнить действие и при необходимости обработать исключение, которое возникнет в случае попытки нарушения целостности.
- Использовать один оператор SQL.
Проблемы с согласованностью возникают из-за того, что в промежутке между операторами может завершиться другая транзакция, и видимые данные изменятся. Если оператор один, то и промежутков никаких нет.
Это общие табличные выражения (CTE), в которых, в том числе, можно использовать операторы INSERT, UPDATE, DELETE, а также оператор INSERT ON CONFLICT, который атомарно реализует логику «вставить, а если строка уже есть, то обновить».
